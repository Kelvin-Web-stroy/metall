<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî –ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</title>
  <meta name="description" content="–ö–∞—Ç–∞–ª–æ–≥ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç–∞: –¶–≤–µ—Ç–Ω–æ–π –∏ –ß–µ—Ä–Ω—ã–π. –§–∏–ª—å—Ç—Ä—ã: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–≥—Ä—É–ø–ø–∞ ‚Üí —Ç–æ–≤–∞—Ä."/>
  <link rel="stylesheet" href="assets/site.css"/>
  <link rel="stylesheet" href="assets/catalog.css"/>
</head>
<body>

<header>
  <div class="container">
    <div class="head">
      <a class="brand" href="index.html">
        <span class="logo" aria-hidden="true"></span>
        <span class="name">–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª<span class="tag">–∫–∞—Ç–∞–ª–æ–≥ –∏ —Ü–µ–Ω—ã</span></span>
      </a>

      <a class="catalog-btn" href="catalog.html" title="–ö–∞—Ç–∞–ª–æ–≥">
        <span class="burger"><i></i></span>
        –ö–∞—Ç–∞–ª–æ–≥
      </a>

      <form class="search" onsubmit="return false">
        <input id="q" placeholder="–ü–æ–∏—Å–∫: –º–∞—Ä–∫–∞, —Ä–∞–∑–º–µ—Ä, –ì–û–°–¢, —Ç–æ–≤–∞—Ä‚Ä¶" />
        <button type="button" id="btnFind">–ù–∞–π—Ç–∏</button>
      </form>

      <div class="head-right">
        <a class="cart-link" href="cart.html" title="–ö–æ—Ä–∑–∏–Ω–∞">
          üõí –ö–æ—Ä–∑–∏–Ω–∞
          <span class="cart-badge" data-cart-badge style="display:none">0</span>
        </a>
        <div class="mini-links">
          <a href="index.html#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
          <span>¬∑</span>
          <a href="index.html#services">–£—Å–ª—É–≥–∏</a>
        </div>
        <a class="phone" href="tel:+79000000000">+7 (900) 000-00-00</a>
      </div>
    </div>
  </div>
</header>

<main class="container page">
  <h1 class="page-title">–ö–∞—Ç–∞–ª–æ–≥ –∏ —Ü–µ–Ω—ã</h1>
  <p class="page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–≥—Ä—É–ø–ø—É ‚Üí —Ç–æ–≤–∞—Ä. –î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ: ‚Äú—Ç–æ–≤–∞—Ä + –æ–ø–∏—Å–∞–Ω–∏–µ + —Ü–µ–Ω–∞‚Äù.</p>

  <div class="catalog-wrap">
    <aside class="sidebar">
      <h3>–§–∏–ª—å—Ç—Ä—ã</h3>

      <label class="small" style="color:var(--muted); font-weight:900">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
      <select id="dir" class="field">
        <option value="color">–¶–≤–µ—Ç–Ω–æ–π –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç</option>
        <option value="black">–ß–µ—Ä–Ω–∞—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è</option>
      </select>

      <div style="height:10px"></div>

      <label class="small" style="color:var(--muted); font-weight:900">–ü–æ–¥–≥—Ä—É–ø–ø–∞</label>
      <select id="sub" class="field">
        <option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>
      </select>

      <div style="height:10px"></div>

      <label class="small" style="color:var(--muted); font-weight:900">–¢–æ–≤–∞—Ä</label>
      <select id="prod" class="field">
        <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
      </select>

      <div class="filters">
        <div>
          <label class="small" style="color:var(--muted); font-weight:900">–¶–µ–Ω–∞ –æ—Ç</label>
          <input id="pmin" class="field" inputmode="numeric" placeholder="0"/>
        </div>
        <div>
          <label class="small" style="color:var(--muted); font-weight:900">–¶–µ–Ω–∞ –¥–æ</label>
          <input id="pmax" class="field" inputmode="numeric" placeholder="999999"/>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="pill">–ù–∞–π–¥–µ–Ω–æ: <span id="count">‚Äî</span></span>
      </div>

      <div class="switch-row" style="margin-top:12px">
        <div class="switch-text">
          <b>–ß–µ—Ä–º–µ—Ç: –≤—Å–µ —Ü–µ–Ω—ã</b>
          <span class="small" style="color:var(--muted)">–≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã</span>
        </div>
        <label class="switch">
          <input id="toggleAllPrices" type="checkbox">
          <span class="slider"></span>
        </label>
      </div>
    </aside>

    <section>
      <div class="notice">
        <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –≤—Å—ë –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–ø–∏—Å–∞–Ω–∏—è, —Ü–µ–Ω—ã ‚Äî –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.
      </div>

      <div id="out" style="margin-top:14px"></div>
    </section>
  </div>
</main>

<footer>
  <div class="container foot">
    <div>
      <b>–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</b><br/>
      <div class="small">–ö–∞—Ç–∞–ª–æ–≥ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ <b>products.json</b>. –î–ª—è –Ω–∞–ª–∏—á–∏—è –∏ —Å—Ä–æ–∫–æ–≤ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç–µ —Å—á—ë—Ç.</div>
    </div>
    <div>
      <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b><br/>
      <a href="tel:+79000000000">+7 (900) 000-00-00</a> ¬∑ <a href="mailto:sales@gerametal.ru">sales@gerametal.ru</a><br/>
      <div class="small" style="margin-top:8px">¬© <span id="y"></span></div>
    </div>
  </div>
</footer>

<script src="assets/app.js"></script>

<script>
  document.getElementById('y').textContent = new Date().getFullYear();

  const fmtInt = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU').format(n));
  const fmtMoney = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 2}).format(n));

  function escapeHtml(str){
    return (str || '').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  function parseHash(){
    const hp = new URLSearchParams((location.hash || "").replace(/^#/, ""));
    const qp = new URLSearchParams(location.search || "");
    return {
      dir: hp.get("dir") || qp.get("dir"),
      sub: hp.get("sub") || qp.get("sub"),
      prod: hp.get("prod") || qp.get("prod"),
      search: hp.get("search") || qp.get("search"),
    };
  }

  function normUnit(u){
    if(!u) return "";
    const s = String(u).trim();
    if(!s) return "";
    if(s.toLowerCase().includes("nan")) return "";
    return s;
  }
  function normRange(r){
    if(!r) return "–¶–µ–Ω–∞";
    const s = String(r).trim();
    if(!s) return "–¶–µ–Ω–∞";
    if(s.toLowerCase() === "nan") return "–¶–µ–Ω–∞";
    return s;
  }

  function priceMinOf(p){
    let min = null;
    for(const pr of (p.prices || [])){
      if(typeof pr.value === "number"){
        if(min === null || pr.value < min) min = pr.value;
      }
    }
    return min;
  }

  function withinPrice(p, min, max){
    const v = priceMinOf(p);
    if(v === null) return true;
    if(min && v < min) return false;
    if(max && v > max) return false;
    return true;
  }

  function rowMatches(p, q){
    if(!q) return true;
    const hay = (
      (p.direction_label||"") + " " +
      (p.subgroup||"") + " " +
      (p.product||"") + " " +
      JSON.stringify(p.attrs||{})
    ).toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function bindAddButtons(){
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        try{
          const p = JSON.parse(decodeURIComponent(btn.getAttribute('data-add')));
          cartAdd(p);
          btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ';
          setTimeout(()=>btn.textContent='–í –∫–æ—Ä–∑–∏–Ω—É', 900);
        }catch(e){}
      });
    });
  }

  function buildPriceLineColor(p){
    const pr = (p.prices && p.prices[0]) ? p.prices[0] : null;
    if(!pr) return "‚Äî";
    if(typeof pr.value === "number") return `${fmtMoney(pr.value)} ${pr.unit || "‚ÇΩ/–∫–≥"}`;
    if(pr.note) return pr.note;
    return "‚Äî";
  }

  function buildPriceLineBlack(p, showAll){
    // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä—ã range+unit ‚Üí value
    const arr = [];
    for(const pr of (p.prices || [])){
      const range = normRange(pr.range);
      const unit = normUnit(pr.unit);
      const label = unit ? `${range} ${unit}` : `${range}`;
      let val = "‚Äî";
      if(typeof pr.value === "number") val = fmtInt(pr.value);
      else if(pr.note) val = pr.note;

      arr.push({ range, unit, label, val });
    }

    // –∫–æ–º–ø–∞–∫—Ç: –±–µ—Ä–µ–º 4 –ø–µ—Ä–≤—ã—Ö –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö —Ü–µ–Ω—ã
    const compact = showAll ? arr : arr.filter(x=>x.val!=="‚Äî").slice(0,4);
    if(compact.length === 0) return "‚Äî";

    return compact.map(x => `${x.label}: ${x.val}`).join(" ¬∑ ");
  }

  function buildDescColor(p){
    const a = p.attrs || {};
    const parts = [];
    if(a["–ú–∞—Ä–∫–∞/—Å–ø–ª–∞–≤"]) parts.push(`–ú–∞—Ä–∫–∞: ${a["–ú–∞—Ä–∫–∞/—Å–ø–ª–∞–≤"]}`);
    if(a["–†–∞–∑–º–µ—Ä/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã"]) parts.push(`–†–∞–∑–º–µ—Ä: ${a["–†–∞–∑–º–µ—Ä/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã"]}`);
    if(a["–ì–û–°–¢/–¢–£"]) parts.push(`–ì–û–°–¢: ${a["–ì–û–°–¢/–¢–£"]}`);
    if(a["–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ"]) parts.push(`–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: ${a["–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ"]}`);
    return parts.join(" ‚Ä¢ ");
  }

  function buildDescBlack(p){
    const a = p.attrs || {};
    const parts = [];
    if(a["–î–ª–∏–Ω–∞"]) parts.push(`–î–ª–∏–Ω–∞: ${a["–î–ª–∏–Ω–∞"]}`);
    if(a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]) parts.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]}`);
    if(a["–ì–û–°–¢/–¢–£"]) parts.push(`–ì–û–°–¢: ${a["–ì–û–°–¢/–¢–£"]}`);
    if(a["–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏"]) parts.push(`–°—Ç–∞–ª—å: ${a["–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏"]}`);
    return parts.join(" ‚Ä¢ ");
  }

  function renderSection(title, list, direction, showAllPrices){
    const rows = list.map(p=>{
      const data = encodeURIComponent(JSON.stringify(p));
      const desc = (direction==="color") ? buildDescColor(p) : buildDescBlack(p);
      const price = (direction==="color") ? buildPriceLineColor(p) : buildPriceLineBlack(p, showAllPrices);

      return `
        <tr>
          <td>
            <b>${escapeHtml(p.product||"")}</b>
            <div class="row-meta">${escapeHtml(desc || "")}</div>
          </td>
          <td class="mono">${escapeHtml(price)}</td>
          <td style="width:140px"><button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button></td>
        </tr>
      `;
    }).join("");

    return `
      <section class="cat-section">
        <div class="cat-head">
          <h2 class="cat-title">${escapeHtml(title)}</h2>
          <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
        </div>

        <div class="table-wrap">
          <table class="table table-simple" style="min-width: 820px">
            <thead>
              <tr>
                <th>–¢–æ–≤–∞—Ä –∏ –æ–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–¶–µ–Ω–∞</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="3" style="color:var(--muted)">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`}
            </tbody>
          </table>
        </div>
      </section>
    `;
  }

  async function main(){
    const res = await fetch('products.json', {cache:'no-store'});
    const products = await res.json();

    const $dir = document.querySelector('#dir');
    const $sub = document.querySelector('#sub');
    const $prod = document.querySelector('#prod');
    const $q = document.querySelector('#q');
    const $pmin = document.querySelector('#pmin');
    const $pmax = document.querySelector('#pmax');
    const $out = document.querySelector('#out');
    const $count = document.querySelector('#count');
    const $btn = document.querySelector('#btnFind');
    const $toggle = document.querySelector('#toggleAllPrices');

    const LS_KEY = "gm_black_all_prices";
    $toggle.checked = (localStorage.getItem(LS_KEY) === "1");

    const hash = parseHash();
    if(hash.dir){ $dir.value = hash.dir; }
    if(hash.search){ $q.value = hash.search; }

    function subgroupsFor(dir){
      return [...new Set(products.filter(p=>p.direction===dir).map(p=>p.subgroup).filter(Boolean))].sort();
    }
    function productsFor(dir, sub){
      return [...new Set(products.filter(p=>p.direction===dir && (!sub || p.subgroup===sub)).map(p=>p.product).filter(Boolean))].sort();
    }

    function refillSub(){
      const dir = $dir.value;
      const subs = subgroupsFor(dir);
      $sub.innerHTML = '<option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>' + subs.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
      $sub.value = "";
    }

    function refillProd(){
      const dir = $dir.value;
      const sub = $sub.value || "";
      const prods = productsFor(dir, sub);
      $prod.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>' + prods.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
      $prod.value = "";
    }

    function apply(){
      const dir = $dir.value;
      const sub = $sub.value || "";
      const prod = $prod.value || "";
      const q = ($q.value || "").trim();
      const min = parseInt(($pmin.value||"").replace(/\D/g,""),10) || null;
      const max = parseInt(($pmax.value||"").replace(/\D/g,""),10) || null;
      const showAllPrices = $toggle.checked;

      const filtered = products.filter(p =>
        p.direction === dir &&
        (!sub || p.subgroup === sub) &&
        (!prod || p.product === prod) &&
        rowMatches(p, q) &&
        withinPrice(p, min, max)
      );

      $count.textContent = filtered.length;

      const map = new Map();
      for(const p of filtered){
        const key = p.subgroup || "–ë–µ–∑ –ø–æ–¥–≥—Ä—É–ø–ø—ã";
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(p);
      }

      let html = "";
      for(const [k, list] of map.entries()){
        html += renderSection(k, list, dir, showAllPrices);
      }

      $out.innerHTML = html || '<div class="notice">–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
      bindAddButtons();
    }

    $toggle.addEventListener('change', ()=>{
      localStorage.setItem(LS_KEY, $toggle.checked ? "1" : "0");
      apply();
    });

    $dir.addEventListener('change', ()=>{ refillSub(); refillProd(); apply(); });
    $sub.addEventListener('change', ()=>{ refillProd(); apply(); });
    $prod.addEventListener('change', apply);
    [$q, $pmin, $pmax].forEach(el => el.addEventListener('input', apply));
    $btn.addEventListener('click', apply);

    refillSub();
    refillProd();
    apply();
  }

  main();
</script>

</body>
</html>