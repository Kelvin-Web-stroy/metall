<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî –ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</title>
  <meta name="description" content="–ö–∞—Ç–∞–ª–æ–≥: 3 —É—Ä–æ–≤–Ω—è ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí —Ç–æ–≤–∞—Ä. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –∑–∞—è–≤–∫–∏."/>
  <link rel="stylesheet" href="assets/site.css"/>
  <link rel="stylesheet" href="assets/catalog.css"/>
</head>
<body>

<header>
  <div class="container">
    <div class="head">
      <a class="brand" href="index.html">
        <span class="logo" aria-hidden="true">
          <img src="assets/img/logo.png" alt="–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª">
        </span>
        <span class="name">–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª<span class="tag">–∫–∞—Ç–∞–ª–æ–≥</span></span>
      </a>

      <a class="catalog-btn" href="catalog.html" title="–ö–∞—Ç–∞–ª–æ–≥">
        <span class="burger"><i></i></span>
        –ö–∞—Ç–∞–ª–æ–≥
      </a>

      <form class="search" onsubmit="return false">
        <input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ –æ–ø–∏—Å–∞–Ω–∏—é‚Ä¶" />
        <button type="button" id="btnFind">–ù–∞–π—Ç–∏</button>
      </form>

      <div class="head-right">
        <a class="cart-link" href="cart.html" title="–ö–æ—Ä–∑–∏–Ω–∞">
          üõí –ö–æ—Ä–∑–∏–Ω–∞
          <span class="cart-badge" data-cart-badge style="display:none">0</span>
        </a>
        <div class="mini-links">
          <a href="index.html#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
          <span>¬∑</span>
          <a href="index.html#services">–£—Å–ª—É–≥–∏</a>
        </div>
        <a class="phone" href="tel:+79000000000">+7 (900) 000-00-00</a>
      </div>
    </div>
  </div>
</header>

<main class="container page">
  <h1 class="page-title">–ö–∞—Ç–∞–ª–æ–≥</h1>
  <p class="page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Üí —Ç–æ–≤–∞—Ä. –¶–µ–Ω—ã ‚Äî –ø–æ –∑–∞–ø—Ä–æ—Å—É. –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –∑–∞—è–≤–∫–∏.</p>

  <div class="catalog-wrap">
    <aside class="sidebar">
      <h3>–§–∏–ª—å—Ç—Ä—ã</h3>

      <label class="small" style="color:var(--muted); font-weight:900">–ì–ª–∞–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="main" class="field">
        <option value="">–í—Å–µ</option>
      </select>

      <div style="height:10px"></div>

      <label class="small" style="color:var(--muted); font-weight:900">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="sub" class="field">
        <option value="">–í—Å–µ</option>
      </select>

      <div style="height:10px"></div>

      <label class="small" style="color:var(--muted); font-weight:900">–¢–æ–≤–∞—Ä</label>
      <select id="prod" class="field">
        <option value="">–í—Å–µ</option>
      </select>

      <div style="margin-top:10px">
        <span class="pill">–ù–∞–π–¥–µ–Ω–æ: <span id="count">‚Äî</span></span>
      </div>
    </aside>

    <section class="catalog-main">
      <div class="notice">
        <b>–¶–µ–Ω—ã:</b> –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –∑–∞–ø—Ä–æ—Å—É ‚Äî —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∫–æ—Ä–∑–∏–Ω—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É.
      </div>

      <div id="out" style="margin-top:14px"></div>
    </section>
  </div>
</main>

<footer>
  <div class="container foot">
    <div>
      <b>–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</b><br/>
      <div class="small">–î–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ <b>products.json</b>.</div>
    </div>
    <div>
      <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b><br/>
      <a href="tel:+79000000000">+7 (900) 000-00-00</a> ¬∑ <a href="mailto:sales@gerametal.ru">sales@gerametal.ru</a><br/>
      <div class="small" style="margin-top:8px">¬© <span id="y"></span></div>
    </div>
  </div>
</footer>

<script src="assets/app.js"></script>

<script>
  document.getElementById('y').textContent = new Date().getFullYear();

  function escapeHtml(str){
    return (str || '').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  function parseParams(){
    const qp = new URLSearchParams(location.search || "");
    const hp = new URLSearchParams((location.hash || "").replace(/^#/, ""));
    return {
      main: hp.get("main") || qp.get("main") || "",
      sub: hp.get("sub") || qp.get("sub") || "",
      prod: hp.get("prod") || qp.get("prod") || "",
      q: hp.get("search") || qp.get("search") || "",
    };
  }

  function matchText(p, q){
    if(!q) return true;
    const hay = (p.main+" "+p.sub+" "+p.product+" "+(p.description||"")+" "+(p.gost||"")).toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function renderList(title, list){
    const rows = list.map(p=>{
      const data = encodeURIComponent(JSON.stringify(p));
      const desc = [p.description, p.gost ? ("–ì–û–°–¢: "+p.gost) : ""].filter(Boolean).join(" ‚Ä¢ ");
      return `
        <div class="prod-card">
          <div class="prod-main">
            <div class="prod-title">${escapeHtml(p.product)}</div>
            <div class="prod-sub">${escapeHtml([p.main, p.sub].filter(Boolean).join(" ‚Ä¢ "))}</div>
            ${desc ? `<div class="prod-desc">${escapeHtml(desc)}</div>` : ``}
          </div>
          <div class="prod-actions">
            <button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;
    }).join("");

    return `
      <section class="cat-section">
        <div class="cat-head">
          <h2 class="cat-title">${escapeHtml(title)}</h2>
          <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
        </div>
        <div class="prod-list">
          ${rows || `<div class="notice">–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`}
        </div>
      </section>
    `;
  }

  function bindAddButtons(){
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        try{
          const p = JSON.parse(decodeURIComponent(btn.getAttribute('data-add')));
          cartAdd(p);
          btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ';
          setTimeout(()=>btn.textContent='–í –∫–æ—Ä–∑–∏–Ω—É', 900);
        }catch(e){}
      });
    });
  }

  async function main(){
    const res = await fetch('products.json', {cache:'no-store'});
    const products = await res.json();

    const $main = document.querySelector('#main');
    const $sub = document.querySelector('#sub');
    const $prod = document.querySelector('#prod');
    const $q = document.querySelector('#q');
    const $btn = document.querySelector('#btnFind');
    const $out = document.querySelector('#out');
    const $count = document.querySelector('#count');

    const params = parseParams();
    if(params.q) $q.value = params.q;

    const mains = [...new Set(products.map(p=>p.main).filter(Boolean))].sort();
    $main.innerHTML = '<option value="">–í—Å–µ</option>' + mains.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');

    function fillSubs(){
      const m = $main.value;
      const subs = [...new Set(products.filter(p=>!m || p.main===m).map(p=>p.sub).filter(Boolean))].sort();
      $sub.innerHTML = '<option value="">–í—Å–µ</option>' + subs.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
    }
    function fillProds(){
      const m = $main.value;
      const s = $sub.value;
      const prods = [...new Set(products.filter(p=>(!m||p.main===m)&&(!s||p.sub===s)).map(p=>p.product).filter(Boolean))].sort();
      $prod.innerHTML = '<option value="">–í—Å–µ</option>' + prods.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
    }

    if(params.main && mains.includes(params.main)){ $main.value = params.main; }
    fillSubs();
    if(params.sub){
      const subsNow=[...new Set(products.filter(p=>!params.main || p.main===params.main).map(p=>p.sub).filter(Boolean))];
      if(subsNow.includes(params.sub)) $sub.value=params.sub;
    }
    fillProds();
    if(params.prod){
      const prodsNow=[...new Set(products.filter(p=>(!params.main||p.main===params.main)&&(!params.sub||p.sub===params.sub)).map(p=>p.product).filter(Boolean))];
      if(prodsNow.includes(params.prod)) $prod.value=params.prod;
    }

    function apply(){
      const m=$main.value;
      const s=$sub.value;
      const pr=$prod.value;
      const q=($q.value||"").trim();

      const filtered = products.filter(p =>
        (!m || p.main===m) &&
        (!s || p.sub===s) &&
        (!pr || p.product===pr) &&
        matchText(p,q)
      );

      $count.textContent = filtered.length;

      // group by subcategory for readability
      const map=new Map();
      for(const p of filtered){
        const key = p.sub || "–ë–µ–∑ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏";
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(p);
      }

      let html="";
      for(const [k, list] of map.entries()){
        html += renderList(k, list);
      }
      $out.innerHTML = html || `<div class="notice">–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;
      bindAddButtons();
    }

    $main.addEventListener('change', ()=>{ fillSubs(); fillProds(); apply(); });
    $sub.addEventListener('change', ()=>{ fillProds(); apply(); });
    $prod.addEventListener('change', apply);
    $q.addEventListener('input', apply);
    $btn.addEventListener('click', apply);

    apply();
  }

  main();
</script>

</body>
</html>
