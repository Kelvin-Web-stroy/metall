<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî –ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</title>
  <meta name="description" content="–ö–∞—Ç–∞–ª–æ–≥ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç–∞: –¶–≤–µ—Ç–Ω–æ–π –∏ –ß–µ—Ä–Ω—ã–π. –§–∏–ª—å—Ç—Ä—ã: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–≥—Ä—É–ø–ø–∞ ‚Üí —Ç–æ–≤–∞—Ä."/>
  <link rel="stylesheet" href="assets/site.css"/>
  <link rel="stylesheet" href="assets/catalog.css"/>
</head>
<body>

  <header>
    <div class="container">
      <div class="head">
        <a class="brand" href="index.html">
          <span class="logo" aria-hidden="true"></span>
          <span class="name">–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª<span class="tag">–∫–∞—Ç–∞–ª–æ–≥ –∏ —Ü–µ–Ω—ã</span></span>
        </a>

        <a class="catalog-btn" href="catalog.html" title="–ö–∞—Ç–∞–ª–æ–≥">
          <span class="burger"><i></i></span>
          –ö–∞—Ç–∞–ª–æ–≥
        </a>

        <form class="search" onsubmit="return false">
          <input id="q" placeholder="–ü–æ–∏—Å–∫: –º–∞—Ä–∫–∞, —Ä–∞–∑–º–µ—Ä, –ì–û–°–¢, —Ç–æ–≤–∞—Ä‚Ä¶" />
          <button type="button" id="btnFind">–ù–∞–π—Ç–∏</button>
        </form>

        <div class="head-right">
          <a class="cart-link" href="cart.html" title="–ö–æ—Ä–∑–∏–Ω–∞">
            üõí –ö–æ—Ä–∑–∏–Ω–∞
            <span class="cart-badge" data-cart-badge style="display:none">0</span>
          </a>
          <div class="mini-links">
            <a href="index.html#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            <span>¬∑</span>
            <a href="index.html#services">–£—Å–ª—É–≥–∏</a>
          </div>
          <a class="phone" href="tel:+79000000000">+7 (900) 000-00-00</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container page">
    <h1 class="page-title">–ö–∞—Ç–∞–ª–æ–≥ –∏ —Ü–µ–Ω—ã</h1>
    <p class="page-sub">–§–∏–ª—å—Ç—Ä—ã: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–≥—Ä—É–ø–ø–∞ ‚Üí —Ç–æ–≤–∞—Ä. –î–ª—è —á–µ—Ä–Ω–æ–≥–æ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç–∞ —Ü–µ–Ω—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –æ–±—ä—ë–º–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã (—Ç/–º/—à—Ç).</p>

    <div class="catalog-wrap">
      <aside class="sidebar">
        <h3>–§–∏–ª—å—Ç—Ä—ã</h3>

        <label class="small" style="color:var(--muted); font-weight:900">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
        <select id="dir" class="field">
          <option value="color">–¶–≤–µ—Ç–Ω–æ–π –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç</option>
          <option value="black">–ß–µ—Ä–Ω–∞—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è</option>
        </select>

        <div style="height:10px"></div>

        <label class="small" style="color:var(--muted); font-weight:900">–ü–æ–¥–≥—Ä—É–ø–ø–∞</label>
        <select id="sub" class="field">
          <option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>
        </select>

        <div style="height:10px"></div>

        <label class="small" style="color:var(--muted); font-weight:900">–¢–æ–≤–∞—Ä</label>
        <select id="prod" class="field">
          <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
        </select>

        <div class="filters">
          <div>
            <label class="small" style="color:var(--muted); font-weight:900">–¶–µ–Ω–∞ –æ—Ç</label>
            <input id="pmin" class="field" inputmode="numeric" placeholder="0"/>
          </div>
          <div>
            <label class="small" style="color:var(--muted); font-weight:900">–¶–µ–Ω–∞ –¥–æ</label>
            <input id="pmax" class="field" inputmode="numeric" placeholder="999999"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <span class="pill">–ù–∞–π–¥–µ–Ω–æ: <span id="count">‚Äî</span></span>
        </div>

        <div class="switch-row" style="margin-top:12px">
          <div class="switch-text">
            <b>–ß–µ—Ä–º–µ—Ç: –≤–∏–¥ —Ü–µ–Ω</b>
            <span class="small" style="color:var(--muted)">–ö–æ–º–ø–∞–∫—Ç–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
          </div>
          <label class="switch">
            <input id="toggleAllPrices" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
      </aside>

      <section>
        <div class="notice">
          <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> —Ü–≤–µ—Ç–º–µ—Ç ‚Äî ‚ÇΩ/–∫–≥. –ß–µ—Ä–º–µ—Ç ‚Äî —Ü–µ–Ω—ã –ø–æ –æ–±—ä—ë–º—É –∏ –µ–¥–∏–Ω–∏—Ü–µ. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ‚Äú–í—Å–µ —Ü–µ–Ω—ã‚Äù —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å.
        </div>

        <div id="out" style="margin-top:14px"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container foot">
      <div>
        <b>–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</b><br/>
        <div class="small">–ö–∞—Ç–∞–ª–æ–≥ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ <b>products.json</b>. –î–ª—è –Ω–∞–ª–∏—á–∏—è –∏ —Å—Ä–æ–∫–æ–≤ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç–µ —Å—á—ë—Ç.</div>
      </div>
      <div>
        <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b><br/>
        <a href="tel:+79000000000">+7 (900) 000-00-00</a> ¬∑ <a href="mailto:sales@gerametal.ru">sales@gerametal.ru</a><br/>
        <div class="small" style="margin-top:8px">¬© <span id="y"></span></div>
      </div>
    </div>
  </footer>

  <!-- app.js –î–û –ª–æ–≥–∏–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ -->
  <script src="assets/app.js"></script>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    const fmtInt = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU').format(n));
    const fmtMoney = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 2}).format(n));

    function escapeHtml(str){
      return (str || '').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function normUnit(u){
      if(!u) return "";
      const s = String(u).trim();
      if(!s) return "";
      if(s.toLowerCase().includes("nan")) return "";
      return s;
    }
    function normRange(r){
      if(!r) return "–¶–µ–Ω–∞";
      const s = String(r).trim();
      if(!s) return "–¶–µ–Ω–∞";
      if(s.toLowerCase() === "nan") return "–¶–µ–Ω–∞";
      return s;
    }

    function parseHash(){
      // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞: #dir=black –∏ ?dir=black
      const hp = new URLSearchParams((location.hash || "").replace(/^#/, ""));
      const qp = new URLSearchParams(location.search || "");
      return {
        dir: hp.get("dir") || qp.get("dir"),
        sub: hp.get("sub") || qp.get("sub"),
        prod: hp.get("prod") || qp.get("prod"),
        search: hp.get("search") || qp.get("search"),
      };
    }

    function priceMinOf(p){
      let min = null;
      for(const pr of (p.prices || [])){
        if(typeof pr.value === "number"){
          if(min === null || pr.value < min) min = pr.value;
        }
      }
      return min;
    }

    function withinPrice(p, min, max){
      const v = priceMinOf(p);
      if(v === null) return true;
      if(min && v < min) return false;
      if(max && v > max) return false;
      return true;
    }

    function rowMatches(p, q){
      if(!q) return true;
      const hay = (
        (p.direction_label||"") + " " +
        (p.subgroup||"") + " " +
        (p.product||"") + " " +
        JSON.stringify(p.attrs||{})
      ).toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function bindAddButtons(){
      document.querySelectorAll('[data-add]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          try{
            const p = JSON.parse(decodeURIComponent(btn.getAttribute('data-add')));
            cartAdd(p);
            btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ';
            setTimeout(()=>btn.textContent='–í –∫–æ—Ä–∑–∏–Ω—É', 900);
          }catch(e){}
        });
      });
    }

    // ===== –ß–µ—Ä–º–µ—Ç: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –æ–±—ä—ë–º—É (range) + –µ–¥–∏–Ω–∏—Ü–µ (unit) =====
    function buildBlackPriceGroups(list){
      const orderRanges = [];
      const map = new Map(); // range -> Set(units)

      for(const p of list){
        for(const pr of (p.prices || [])){
          const range = normRange(pr.range);
          const unit = normUnit(pr.unit); // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ
          if(!map.has(range)){
            map.set(range, new Set());
            orderRanges.push(range);
          }
          map.get(range).add(unit);
        }
      }

      const priority = {"‚ÇΩ/—Ç":1,"‚ÇΩ/–∫–≥":2,"‚ÇΩ/–º":3,"‚ÇΩ/—à—Ç":4,"":9};
      const groupArr = [];
      for(const r of orderRanges){
        const units = Array.from(map.get(r));
        units.sort((a,b)=> (priority[a]||50) - (priority[b]||50) || a.localeCompare(b));
        groupArr.push({
          range: r,
          units,
          keys: units.map(u => `${r}|${u}`)
        });
      }
      return groupArr;
    }

    function blackPriceMap(p){
      const m = new Map(); // key "range|unit" -> {val,note}
      for(const pr of (p.prices || [])){
        const range = normRange(pr.range);
        const unit = normUnit(pr.unit);
        const key = `${range}|${unit}`;
        const val = (typeof pr.value === "number") ? pr.value : null;
        const note = pr.note ? String(pr.note) : null;
        m.set(key, {val, note});
      }
      return m;
    }

    function pickCompactGroups(groups){
      // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º:
      // - –¥–æ 3 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤: –ø–µ—Ä–≤—ã–π + —Å–µ—Ä–µ–¥–∏–Ω–∞ + –ø–æ—Å–ª–µ–¥–Ω–∏–π
      // - –º–∞–∫—Å–∏–º—É–º 2 –µ–¥–∏–Ω–∏—Ü—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
      const n = groups.length;
      if(n === 0) return [];
      if(n <= 3){
        return groups.map(g => ({
          ...g,
          units: g.units.slice(0, 2),
          keys: g.units.slice(0, 2).map(u => `${g.range}|${u}`)
        }));
      }

      const idxs = new Set([0, Math.floor((n-1)/2), n-1]);
      const picked = [...idxs].sort((a,b)=>a-b).map(i => groups[i]);

      return picked.map(g => ({
        ...g,
        units: g.units.slice(0, 2),
        keys: g.units.slice(0, 2).map(u => `${g.range}|${u}`)
      }));
    }

    function renderSection(title, list, direction, showAllPrices){
      // ===== –¶–≤–µ—Ç–º–µ—Ç =====
      if(direction === "color"){
        const rows = list.map(p=>{
          const data = encodeURIComponent(JSON.stringify(p));
          const a = p.attrs || {};
          const pr = (p.prices && p.prices[0]) ? p.prices[0] : null;
          const priceTxt = pr ? ((typeof pr.value === "number") ? fmtMoney(pr.value) : (pr.note || "‚Äî")) : "‚Äî";

          return `
            <tr>
              <td><b>${escapeHtml(p.product||"")}</b></td>
              <td>${escapeHtml(a["–ú–∞—Ä–∫–∞/—Å–ø–ª–∞–≤"]||"")}</td>
              <td>${escapeHtml(a["–†–∞–∑–º–µ—Ä/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã"]||"")}</td>
              <td>${escapeHtml(a["–ì–û–°–¢/–¢–£"]||"")}</td>
              <td>${escapeHtml(a["–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ"]||"")}</td>
              <td class="mono">${priceTxt}</td>
              <td><button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button></td>
            </tr>
          `;
        }).join("");

        return `
          <section class="cat-section">
            <div class="cat-head">
              <h2 class="cat-title">${escapeHtml(title)}</h2>
              <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
            </div>

            <div class="table-wrap">
              <table class="table" style="min-width: 980px">
                <thead>
                  <tr>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–ú–∞—Ä–∫–∞/—Å–ø–ª–∞–≤</th>
                    <th>–†–∞–∑–º–µ—Ä/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã</th>
                    <th>–ì–û–°–¢/–¢–£</th>
                    <th>–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</th>
                    <th>‚ÇΩ/–∫–≥</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  ${rows || `<tr><td colspan="7" style="color:var(--muted)">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`}
                </tbody>
              </table>
            </div>
          </section>
        `;
      }

      // ===== –ß–µ—Ä–º–µ—Ç =====
      const allGroups = buildBlackPriceGroups(list);
      const groups = showAllPrices ? allGroups : pickCompactGroups(allGroups);
      const compact = !showAllPrices;

      const head1 = groups.map(g => `<th colspan="${g.units.length}">${escapeHtml(g.range)}</th>`).join("");
      const head2 = groups.map(g => g.units.map(u => `<th>${escapeHtml(u || "–¶–µ–Ω–∞")}</th>`).join("")).join("");

      const rows = list.map(p=>{
        const data = encodeURIComponent(JSON.stringify(p));
        const a = p.attrs || {};
        const pm = blackPriceMap(p);

        const metaLine = [
          a["–î–ª–∏–Ω–∞"] ? `–î–ª–∏–Ω–∞: ${a["–î–ª–∏–Ω–∞"]}` : null,
          a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"] ? `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]}` : null,
          a["–ì–û–°–¢/–¢–£"] ? `–ì–û–°–¢: ${a["–ì–û–°–¢/–¢–£"]}` : null,
          a["–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏"] ? `–°—Ç–∞–ª—å: ${a["–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏"]}` : null,
        ].filter(Boolean).join(" ‚Ä¢ ");

        const priceCells = groups.map(g => {
          return g.units.map(u => {
            const key = `${g.range}|${u}`;
            const cell = pm.get(key);
            if(!cell) return `<td class="mono">‚Äî</td>`;
            if(cell.note) return `<td class="mono">${escapeHtml(cell.note)}</td>`;
            if(typeof cell.val === "number") return `<td class="mono">${fmtInt(cell.val)}</td>`;
            return `<td class="mono">‚Äî</td>`;
          }).join("");
        }).join("");

        if(compact){
          return `
            <tr>
              <td class="sticky-col">
                <b>${escapeHtml(p.product||"")}</b>
                <span class="row-meta">${escapeHtml(metaLine)}</span>
              </td>
              ${priceCells}
              <td><button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button></td>
            </tr>
          `;
        }

        return `
          <tr>
            <td class="sticky-col"><b>${escapeHtml(p.product||"")}</b></td>
            <td class="mono">${escapeHtml(a["–î–ª–∏–Ω–∞"]||"")}</td>
            <td>${escapeHtml(a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"")}</td>
            <td>${escapeHtml(a["–ì–û–°–¢/–¢–£"]||"")}</td>
            <td>${escapeHtml(a["–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏"]||"")}</td>
            ${priceCells}
            <td><button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button></td>
          </tr>
        `;
      }).join("");

      if(compact){
        const priceColsCount = groups.reduce((s,g)=>s+g.units.length,0);
        const totalCols = 1 + priceColsCount + 1;

        return `
          <section class="cat-section">
            <div class="cat-head">
              <h2 class="cat-title">${escapeHtml(title)}</h2>
              <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
            </div>

            <div class="table-wrap">
              <table class="table table-black" style="min-width: 980px">
                <thead>
                  <tr>
                    <th rowspan="2" class="sticky-head">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</th>
                    ${head1}
                    <th rowspan="2"></th>
                  </tr>
                  <tr>
                    ${head2}
                  </tr>
                </thead>
                <tbody>
                  ${rows || `<tr><td colspan="${totalCols}" style="color:var(--muted)">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`}
                </tbody>
              </table>
            </div>
          </section>
        `;
      }

      const baseCols = 5;
      const priceColsCount = groups.reduce((s,g)=>s+g.units.length,0);
      const totalCols = baseCols + priceColsCount + 1;

      return `
        <section class="cat-section">
          <div class="cat-head">
            <h2 class="cat-title">${escapeHtml(title)}</h2>
            <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
          </div>

          <div class="table-wrap">
            <table class="table table-black" style="min-width: 1200px">
              <thead>
                <tr>
                  <th rowspan="2" class="sticky-head">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</th>
                  <th rowspan="2">–î–ª–∏–Ω–∞</th>
                  <th rowspan="2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                  <th rowspan="2">–ì–û–°–¢/–¢–£</th>
                  <th rowspan="2">–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏</th>
                  ${head1}
                  <th rowspan="2"></th>
                </tr>
                <tr>
                  ${head2}
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="${totalCols}" style="color:var(--muted)">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`}
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    async function main(){
      const res = await fetch('products.json', {cache:'no-store'});
      const products = await res.json();

      const $dir = document.querySelector('#dir');
      const $sub = document.querySelector('#sub');
      const $prod = document.querySelector('#prod');
      const $q = document.querySelector('#q');
      const $pmin = document.querySelector('#pmin');
      const $pmax = document.querySelector('#pmax');
      const $out = document.querySelector('#out');
      const $count = document.querySelector('#count');
      const $btn = document.querySelector('#btnFind');
      const $toggle = document.querySelector('#toggleAllPrices');

      // persist toggle
      const LS_KEY = "gm_black_all_prices";
      $toggle.checked = (localStorage.getItem(LS_KEY) === "1");

      const hash = parseHash();
      if(hash.dir){ $dir.value = hash.dir; }
      if(hash.search){ $q.value = hash.search; }

      function subgroupsFor(dir){
        return [...new Set(products.filter(p=>p.direction===dir).map(p=>p.subgroup).filter(Boolean))].sort();
      }
      function productsFor(dir, sub){
        return [...new Set(products.filter(p=>p.direction===dir && (!sub || p.subgroup===sub)).map(p=>p.product).filter(Boolean))].sort();
      }

      function refillSub(){
        const dir = $dir.value;
        const subs = subgroupsFor(dir);
        $sub.innerHTML = '<option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>' + subs.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        if(hash.sub && subs.includes(hash.sub)){ $sub.value = hash.sub; } else { $sub.value = ""; }
      }

      function refillProd(){
        const dir = $dir.value;
        const sub = $sub.value || "";
        const prods = productsFor(dir, sub);
        $prod.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>' + prods.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        if(hash.prod && prods.includes(hash.prod)){ $prod.value = hash.prod; } else { $prod.value = ""; }
      }

      function apply(){
        const dir = $dir.value;
        const sub = $sub.value || "";
        const prod = $prod.value || "";
        const q = ($q.value || "").trim();
        const min = parseInt(($pmin.value||"").replace(/\D/g,""),10) || null;
        const max = parseInt(($pmax.value||"").replace(/\D/g,""),10) || null;

        const showAllPrices = $toggle.checked;

        const filtered = products.filter(p =>
          p.direction === dir &&
          (!sub || p.subgroup === sub) &&
          (!prod || p.product === prod) &&
          rowMatches(p, q) &&
          withinPrice(p, min, max)
        );

        $count.textContent = filtered.length;

        // –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–¥–≥—Ä—É–ø–ø–µ
        const map = new Map();
        for(const p of filtered){
          const key = p.subgroup || "–ë–µ–∑ –ø–æ–¥–≥—Ä—É–ø–ø—ã";
          if(!map.has(key)) map.set(key, []);
          map.get(key).push(p);
        }

        let html = "";
        for(const [k, list] of map.entries()){
          html += renderSection(k, list, dir, showAllPrices);
        }

        $out.innerHTML = html || '<div class="notice">–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
        bindAddButtons();
      }

      $toggle.addEventListener('change', ()=>{
        localStorage.setItem(LS_KEY, $toggle.checked ? "1" : "0");
        apply();
      });

      $dir.addEventListener('change', ()=>{ refillSub(); refillProd(); apply(); });
      $sub.addEventListener('change', ()=>{ refillProd(); apply(); });
      $prod.addEventListener('change', apply);
      [$q, $pmin, $pmax].forEach(el => el.addEventListener('input', apply));
      $btn.addEventListener('click', apply);

      refillSub();
      refillProd();
      apply();
    }

    main();
  </script>
</body>
</html>