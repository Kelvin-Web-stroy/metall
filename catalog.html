<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî –ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</title>
  <meta name="description" content="–ö–∞—Ç–∞–ª–æ–≥ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç–∞: –¶–≤–µ—Ç–Ω–æ–π –∏ –ß–µ—Ä–Ω—ã–π. –§–∏–ª—å—Ç—Ä—ã: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–≥—Ä—É–ø–ø–∞ ‚Üí —Ç–æ–≤–∞—Ä."/>
  <link rel="stylesheet" href="assets/site.css"/>
  <link rel="stylesheet" href="assets/catalog.css"/>
</head>
<body>

  <header>
    <div class="container">
      <div class="head">
        <a class="brand" href="index.html">
          <span class="logo" aria-hidden="true"></span>
          <span class="name">–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª<span class="tag">–∫–∞—Ç–∞–ª–æ–≥ –∏ —Ü–µ–Ω—ã</span></span>
        </a>

        <a class="catalog-btn" href="catalog.html" title="–ö–∞—Ç–∞–ª–æ–≥">
          <span class="burger"><i></i></span>
          –ö–∞—Ç–∞–ª–æ–≥
        </a>

        <form class="search" onsubmit="return false">
          <input id="q" placeholder="–ü–æ–∏—Å–∫: –º–∞—Ä–∫–∞, —Ä–∞–∑–º–µ—Ä, –ì–û–°–¢, —Ç–æ–≤–∞—Ä‚Ä¶" />
          <button type="button" id="btnFind">–ù–∞–π—Ç–∏</button>
        </form>

        <div class="head-right">
          <a class="cart-link" href="cart.html" title="–ö–æ—Ä–∑–∏–Ω–∞">
            üõí –ö–æ—Ä–∑–∏–Ω–∞
            <span class="cart-badge" data-cart-badge style="display:none">0</span>
          </a>
          <div class="mini-links">
            <a href="index.html#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
            <span>¬∑</span>
            <a href="index.html#services">–£—Å–ª—É–≥–∏</a>
          </div>
          <a class="phone" href="tel:+79000000000">+7 (900) 000-00-00</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container page">
    <h1 class="page-title">–ö–∞—Ç–∞–ª–æ–≥ –∏ —Ü–µ–Ω—ã</h1>
    <p class="page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –ø–æ–¥–≥—Ä—É–ø–ø—É ‚Üí —Ç–æ–≤–∞—Ä. –î–ª—è —á—ë—Ä–Ω–æ–≥–æ –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç–∞ —Ü–µ–Ω—ã –º–æ–≥—É—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –æ–±—ä—ë–º–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã (—Ç/–º/—à—Ç).</p>

    <div class="catalog-wrap">
      <aside class="sidebar">
        <h3>–§–∏–ª—å—Ç—Ä—ã</h3>

        <label class="small" style="color:var(--muted); font-weight:900">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
        <select id="dir" class="field">
          <option value="color">–¶–≤–µ—Ç–Ω–æ–π –º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç</option>
          <option value="black">–ß–µ—Ä–Ω–∞—è –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è</option>
        </select>

        <div style="height:10px"></div>

        <label class="small" style="color:var(--muted); font-weight:900">–ü–æ–¥–≥—Ä—É–ø–ø–∞</label>
        <select id="sub" class="field">
          <option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>
        </select>

        <div style="height:10px"></div>

        <label class="small" style="color:var(--muted); font-weight:900">–¢–æ–≤–∞—Ä</label>
        <select id="prod" class="field">
          <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
        </select>

        <div class="filters">
          <div>
            <label class="small" style="color:var(--muted); font-weight:900">–¶–µ–Ω–∞ –æ—Ç</label>
            <input id="pmin" class="field" inputmode="numeric" placeholder="0"/>
          </div>
          <div>
            <label class="small" style="color:var(--muted); font-weight:900">–¶–µ–Ω–∞ –¥–æ</label>
            <input id="pmax" class="field" inputmode="numeric" placeholder="999999"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <span class="pill">–ù–∞–π–¥–µ–Ω–æ: <span id="count">‚Äî</span></span>
        </div>
      </aside>

      <section>
        <div class="notice">
          <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –ø–æ —Ü–≤–µ—Ç–Ω–æ–º—É –º–µ—Ç–∞–ª–ª—É —Ü–µ–Ω–∞ –æ–±—ã—á–Ω–æ –≤ ‚ÇΩ/–∫–≥. –ü–æ —á—ë—Ä–Ω–æ–º—É ‚Äî –≤—ã–≤–æ–¥–∏–º –∫–æ–ª–æ–Ω–∫–∏ ‚Äú–¥–∏–∞–ø–∞–∑–æ–Ω –æ–±—ä—ë–º–∞‚Äù + ‚Äú–µ–¥–∏–Ω–∏—Ü–∞‚Äù.
        </div>

        <div id="out" style="margin-top:14px"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container foot">
      <div>
        <b>–ì–µ—Ä–∞–ú–µ—Ç–∞–ª–ª</b><br/>
        <div class="small">–ö–∞—Ç–∞–ª–æ–≥ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ <b>products.json</b>. –î–ª—è –Ω–∞–ª–∏—á–∏—è –∏ —Å—Ä–æ–∫–æ–≤ ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç–µ —Å—á—ë—Ç.</div>
      </div>
      <div>
        <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b><br/>
        <a href="tel:+79000000000">+7 (900) 000-00-00</a> ¬∑ <a href="mailto:sales@gerametal.ru">sales@gerametal.ru</a><br/>
        <div class="small" style="margin-top:8px">¬© <span id="y"></span></div>
      </div>
    </div>
  </footer>

  <script src="assets/app.js"></script>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    const fmtInt = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU').format(n));
    const fmtMoney = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 2}).format(n));

    function escapeHtml(str){
      return (str || '').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function parseHash(){
      const h = (location.hash || "").replace(/^#/, "");
      const params = new URLSearchParams(h);
      return {
        dir: params.get("dir"),
        sub: params.get("sub"),
        prod: params.get("prod"),
        search: params.get("search"),
      };
    }

    function priceMinOf(p){
      let min = null;
      for(const pr of (p.prices || [])){
        if(typeof pr.value === "number"){
          if(min === null || pr.value < min) min = pr.value;
        }
      }
      return min;
    }

    function withinPrice(p, min, max){
      const v = priceMinOf(p);
      if(v === null) return true;
      if(min && v < min) return false;
      if(max && v > max) return false;
      return true;
    }

    function rowMatches(p, q){
      if(!q) return true;
      const hay = (
        (p.direction_label||"") + " " +
        (p.subgroup||"") + " " +
        (p.product||"") + " " +
        JSON.stringify(p.attrs||{})
      ).toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function priceColsFor(list){
      const cols = [];
      const seen = new Set();
      for(const p of list){
        for(const pr of (p.prices||[])){
          const key = (pr.range||"") + "|" + (pr.unit||"");
          if(seen.has(key)) continue;
          seen.add(key);
          cols.push({ key, range: pr.range||null, unit: pr.unit||null });
        }
      }
      return cols;
    }

    function priceMap(p){
      const map = {};
      for(const pr of (p.prices||[])){
        const key = (pr.range||"") + "|" + (pr.unit||"");
        const val = (typeof pr.value === "number") ? pr.value : null;
        const note = pr.note ? String(pr.note) : null;
        map[key] = { val, note };
      }
      return map;
    }

    function bindAddButtons(){
      document.querySelectorAll('[data-add]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          try{
            const p = JSON.parse(decodeURIComponent(btn.getAttribute('data-add')));
            cartAdd(p);
            btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ';
            setTimeout(()=>btn.textContent='–í –∫–æ—Ä–∑–∏–Ω—É', 900);
          }catch(e){}
        });
      });
    }

    function renderSection(title, list, direction){
      const priceCols = priceColsFor(list);

      if(direction === "color"){
        const rows = list.map(p=>{
          const data = encodeURIComponent(JSON.stringify(p));
          const a = p.attrs || {};
          const pr = (p.prices && p.prices[0]) ? p.prices[0] : null;
          const priceTxt = pr ? ((typeof pr.value === "number") ? fmtMoney(pr.value) : (pr.note || "‚Äî")) : "‚Äî";
          return `
            <tr>
              <td><b>${escapeHtml(p.product||"")}</b></td>
              <td>${escapeHtml(a["–ú–∞—Ä–∫–∞/—Å–ø–ª–∞–≤"]||"")}</td>
              <td>${escapeHtml(a["–†–∞–∑–º–µ—Ä/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã"]||"")}</td>
              <td>${escapeHtml(a["–ì–û–°–¢/–¢–£"]||"")}</td>
              <td>${escapeHtml(a["–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ"]||"")}</td>
              <td class="mono">${priceTxt}</td>
              <td><button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button></td>
            </tr>
          `;
        }).join("");

        return `
          <section class="cat-section">
            <div class="cat-head">
              <h2 class="cat-title">${escapeHtml(title)}</h2>
              <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
            </div>

            <div class="table-wrap">
              <table class="table" style="min-width: 980px">
                <thead>
                  <tr>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–ú–∞—Ä–∫–∞/—Å–ø–ª–∞–≤</th>
                    <th>–†–∞–∑–º–µ—Ä/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã</th>
                    <th>–ì–û–°–¢/–¢–£</th>
                    <th>–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</th>
                    <th>‚ÇΩ/–∫–≥</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  ${rows || `<tr><td colspan="7" style="color:var(--muted)">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`}
                </tbody>
              </table>
            </div>
          </section>
        `;
      }

      // black
      const rows = list.map(p=>{
        const data = encodeURIComponent(JSON.stringify(p));
        const a = p.attrs || {};
        const pm = priceMap(p);
        const priceTds = priceCols.map(col=>{
          const cell = pm[col.key];
          if(!cell) return '<td class="mono">‚Äî</td>';
          if(cell.note) return '<td class="mono">'+escapeHtml(cell.note)+'</td>';
          if(typeof cell.val === "number") return '<td class="mono">'+fmtInt(cell.val)+'</td>';
          return '<td class="mono">‚Äî</td>';
        }).join("");
        return `
          <tr>
            <td><b>${escapeHtml(p.product||"")}</b></td>
            <td class="mono">${escapeHtml(a["–î–ª–∏–Ω–∞"]||"")}</td>
            <td>${escapeHtml(a["–ö–∞—Ç–µ–≥–æ—Ä–∏—è"]||"")}</td>
            <td>${escapeHtml(a["–ì–û–°–¢/–¢–£"]||"")}</td>
            <td>${escapeHtml(a["–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏"]||"")}</td>
            ${priceTds}
            <td><button class="add-btn" data-add="${data}">–í –∫–æ—Ä–∑–∏–Ω—É</button></td>
          </tr>
        `;
      }).join("");

      const ths = priceCols.map(col=>{
        const t = col.range ? col.range : "–¶–µ–Ω–∞";
        const u = col.unit ? " " + col.unit : "";
        return "<th>"+escapeHtml(t+u)+"</th>";
      }).join("");

      return `
        <section class="cat-section">
          <div class="cat-head">
            <h2 class="cat-title">${escapeHtml(title)}</h2>
            <div class="cat-meta">${list.length} –ø–æ–∑–∏—Ü–∏–π</div>
          </div>

          <div class="table-wrap">
            <table class="table" style="min-width: 1200px">
              <thead>
                <tr>
                  <th>–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</th>
                  <th>–î–ª–∏–Ω–∞</th>
                  <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                  <th>–ì–û–°–¢/–¢–£</th>
                  <th>–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏</th>
                  ${ths}
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="${6 + priceCols.length}" style="color:var(--muted)">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`}
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    async function main(){
      const res = await fetch('products.json', {cache:'no-store'});
      const products = await res.json();

      const $dir = document.querySelector('#dir');
      const $sub = document.querySelector('#sub');
      const $prod = document.querySelector('#prod');
      const $q = document.querySelector('#q');
      const $pmin = document.querySelector('#pmin');
      const $pmax = document.querySelector('#pmax');
      const $out = document.querySelector('#out');
      const $count = document.querySelector('#count');
      const $btn = document.querySelector('#btnFind');

      const hash = parseHash();
      if(hash.dir){ $dir.value = hash.dir; }
      if(hash.search){ $q.value = hash.search; }

      function subgroupsFor(dir){
        return [...new Set(products.filter(p=>p.direction===dir).map(p=>p.subgroup).filter(Boolean))].sort();
      }
      function productsFor(dir, sub){
        return [...new Set(products.filter(p=>p.direction===dir && (!sub || p.subgroup===sub)).map(p=>p.product).filter(Boolean))].sort();
      }

      function refillSub(){
        const dir = $dir.value;
        const subs = subgroupsFor(dir);
        $sub.innerHTML = '<option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>' + subs.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        if(hash.sub && subs.includes(hash.sub)){ $sub.value = hash.sub; } else { $sub.value = ""; }
      }

      function refillProd(){
        const dir = $dir.value;
        const sub = $sub.value || "";
        const prods = productsFor(dir, sub);
        $prod.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>' + prods.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        if(hash.prod && prods.includes(hash.prod)){ $prod.value = hash.prod; } else { $prod.value = ""; }
      }

      function apply(){
        const dir = $dir.value;
        const sub = $sub.value || "";
        const prod = $prod.value || "";
        const q = ($q.value || "").trim();
        const min = parseInt(($pmin.value||"").replace(/\D/g,""),10) || null;
        const max = parseInt(($pmax.value||"").replace(/\D/g,""),10) || null;

        let filtered = products.filter(p =>
          p.direction === dir &&
          (!sub || p.subgroup === sub) &&
          (!prod || p.product === prod) &&
          rowMatches(p, q) &&
          withinPrice(p, min, max)
        );

        $count.textContent = filtered.length;

        const map = new Map();
        for(const p of filtered){
          const key = p.subgroup || "–ë–µ–∑ –ø–æ–¥–≥—Ä—É–ø–ø—ã";
          if(!map.has(key)) map.set(key, []);
          map.get(key).push(p);
        }

        let html = "";
        for(const [k, list] of map.entries()){
          html += renderSection(k, list, dir);
        }

        $out.innerHTML = html || '<div class="notice">–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
        bindAddButtons();
      }

      $dir.addEventListener('change', ()=>{ refillSub(); refillProd(); apply(); });
      $sub.addEventListener('change', ()=>{ refillProd(); apply(); });
      $prod.addEventListener('change', apply);
      [$q, $pmin, $pmax].forEach(el => el.addEventListener('input', apply));
      $btn.addEventListener('click', apply);

      refillSub();
      refillProd();
      apply();
    }

    main();
  </script>
</body>
</html>