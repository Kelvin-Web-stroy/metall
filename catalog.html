<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Каталог — ГераМеталл</title>
  <meta name="description" content="Каталог металлопроката по прайсу: группы товаров, фильтры, поиск, цены по объёму."/>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#101723;
      --panel2:#0f1621;
      --text:#e8eef7;
      --muted:#a8b3c2;
      --brand:#3ddc97;
      --brand2:#2bb5ff;
      --border:rgba(255,255,255,.08);
      --shadow: 0 14px 30px rgba(0,0,0,.35);
      --radius:18px;
      --maxw:1160px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1100px 600px at 15% -10%, rgba(61,220,151,.18), transparent 60%),
        radial-gradient(900px 520px at 80% 0%, rgba(43,181,255,.16), transparent 55%),
        linear-gradient(180deg, #070b10, #0b0f14 55%, #070b10);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--maxw); margin:0 auto; padding:0 18px;}
    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background:rgba(7,11,16,.62);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{display:flex; align-items:center; justify-content:space-between; padding:12px 0;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(61,220,151,1), rgba(43,181,255,1));
      box-shadow:0 10px 26px rgba(61,220,151,.18);
    }
    .menu{display:flex; align-items:center; gap:14px; flex-wrap:wrap;}
    .menu a{color:var(--muted); font-weight:650; padding:8px 10px; border-radius:12px;}
    .menu a:hover{color:var(--text); background:rgba(255,255,255,.06)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px; padding:12px 14px; border-radius:14px;
      background:rgba(255,255,255,.06); border:1px solid var(--border);
      box-shadow:0 10px 18px rgba(0,0,0,.25);
      font-weight:750;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(61,220,151,.95), rgba(43,181,255,.95));
      color:#071018; border:0;
    }
    .btn:hover{transform:translateY(-1px)}
    .section{padding:26px 0}
    .section-title{font-size:24px; font-weight:900; margin:0 0 10px}
    .section-sub{color:var(--muted); margin:0 0 16px; line-height:1.6}
    .footer{
      padding:24px 0 38px; border-top:1px solid var(--border);
      color:var(--muted);
    }
    .footer-grid{display:grid; grid-template-columns:1.2fr .8fr; gap:14px}
    @media (max-width: 980px){.footer-grid{grid-template-columns:1fr}}
    .small{font-size:12.5px; line-height:1.55}
    hr.sep{border:none; border-top:1px solid var(--border); margin:18px 0}
    .notice{padding:12px 14px; border-radius:16px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--muted); line-height:1.55}

    /* Catalog extras */
    .catalog-wrap{display:grid; grid-template-columns: 300px 1fr; gap:14px; align-items:start}
    @media (max-width: 980px){.catalog-wrap{grid-template-columns:1fr}}
    .sidebar{
      position:sticky; top:76px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:18px;
      padding:14px;
      max-height: calc(100vh - 96px);
      overflow:auto;
    }
    .sidebar h3{margin:0 0 10px; font-size:14px; letter-spacing:.2px}
    .sidebar a{display:block; padding:8px 10px; border-radius:12px; color:var(--muted); font-weight:650; border:1px solid transparent}
    .sidebar a:hover{color:var(--text); background:rgba(255,255,255,.05); border-color:var(--border)}
    .search{
      width:100%; padding:12px 12px;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(7,11,16,.45);
      color:var(--text);
      outline:none;
    }
    .filters{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width: 520px){.filters{grid-template-columns:1fr}}
    .select{
      width:100%; padding:12px 12px;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(7,11,16,.45);
      color:var(--text);
      outline:none;
    }
    .table{
      width:100%; border-collapse:separate; border-spacing:0;
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background:rgba(255,255,255,.02);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    .table th{
      font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px;
      background:rgba(255,255,255,.04);
      position:sticky; top:0;
    }
    .table tr:last-child td{border-bottom:none}
    .table td.mono{font-family:var(--mono); font-variant-numeric: tabular-nums;}
    .pill{
      display:inline-flex; padding:4px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:700; font-size:12px;
    }
    .cat-section{margin:18px 0 30px}
    .cat-head{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:10px}
    .cat-title{font-size:18px; font-weight:900; margin:0}
    .cat-meta{color:var(--muted); font-weight:650}
    .hint{color:var(--muted); font-size:12.5px; margin-top:10px; line-height:1.55}
  </style>
</head>

<body>
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <span class="logo" aria-hidden="true"></span>
        <span>ГераМеталл</span>
      </a>
      <nav class="menu" aria-label="Навигация">
        <a href="index.html#delivery">Доставка</a>
        <a href="index.html#about">О компании</a>
        <a href="index.html#contacts">Контакты</a>
      </nav>
      <a class="btn primary" href="index.html#contacts">Запросить счёт</a>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 class="section-title" style="margin-bottom:6px">Каталог и цены</h1>
      <p class="section-sub" style="margin-top:0">Каталог собран из прайс-листа. Фильтры помогают быстро найти нужный профиль/размер.</p>

      <div class="catalog-wrap">
        <aside class="sidebar">
          <h3>Поиск</h3>
          <input id="q" class="search" placeholder="Например: Л63, Ø20, труба, шина, лист…" />
          <div class="filters">
            <select id="cat" class="select" aria-label="Категория">
              <option>Загрузка…</option>
            </select>
            <input id="pmin" class="search" placeholder="Цена от, ₽/т" inputmode="numeric"/>
            <input id="pmax" class="search" placeholder="Цена до, ₽/т" inputmode="numeric"/>
          </div>
          <div class="hint">Подсказка: можно искать по размеру, марке, профилю и названию группы.</div>

          <hr class="sep"/>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <b>Найдено:</b> <span id="count" class="pill">—</span>
          </div>

          <hr class="sep"/>
          <h3>Разделы</h3>
          <div id="nav" class="small" style="color:var(--muted)"></div>
        </aside>

        <section>
          <div class="notice">
            <b>Как считать:</b> цены показаны в ₽/т по трём диапазонам объёма. Если нужна резка/доставка — просто добавьте это в запрос.
          </div>
          <div id="out" style="margin-top:14px"></div>
        </section>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <div class="brand"><span class="logo" aria-hidden="true"></span><span>ГераМеталл</span></div>
        <p class="small">Каталог обновляется из прайса. Для актуального наличия и сроков — запросите счёт.</p>
      </div>
      <div class="small">
        <b>Контакты</b><br/>
        <a href="tel:+79000000000">+7 (900) 000-00-00</a> · <a href="mailto:sales@gerametal.ru">sales@gerametal.ru</a><br/>
        <span>Ваш город, ул. Примерная, 10</span>
      </div>
    </div>
  </footer>

  <script>
    const fmtInt = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU').format(n));
    const fmtMoney = (n) => (n===null || n===undefined || n==="" ? "" : new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 2}).format(n));

    function slugify(text){
      return (text || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s-]/gu, "")
        .replace(/\s+/g, "-")
        .slice(0, 80) || "cat";
    }

    function rowMatches(p, q){
      if(!q) return true;
      const hay = (p.category+" "+p.profile+" "+p.size+" "+p.steel+" "+p.length_m).toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function withinPrice(p, min, max){
      const v = p.price_ton_to_0_3 ?? p.price_ton_0_3_1 ?? p.price_ton_1_5;
      if(v===null || v===undefined) return true;
      if(min && v < min) return false;
      if(max && v > max) return false;
      return true;
    }

    function renderSection(cat, list){
      const id = slugify(cat);
      const meta = `${list.length} позиций`;
      const rows = list.map(p => `
        <tr>
          <td><span class="pill">${p.profile || "—"}</span></td>
          <td class="mono">${p.size || "—"}</td>
          <td class="mono">${p.steel || "—"}</td>
          <td class="mono">${p.length_m || "—"}</td>
          <td class="mono">${fmtInt(p.price_ton_to_0_3)}</td>
          <td class="mono">${fmtInt(p.price_ton_0_3_1)}</td>
          <td class="mono">${fmtInt(p.price_ton_1_5)}</td>
          <td class="mono">${p.weight_kg ?? ""}</td>
          <td class="mono">${fmtMoney(p.price_piece_rub)}</td>
        </tr>
      `).join("");

      return `
        <section class="cat-section" id="${id}">
          <div class="cat-head">
            <h2 class="cat-title">${cat}</h2>
            <div class="cat-meta">${meta}</div>
          </div>
          <div style="overflow:auto; border-radius:18px">
            <table class="table">
              <thead>
                <tr>
                  <th>Профиль</th>
                  <th>Размер</th>
                  <th>Марка</th>
                  <th>Длина</th>
                  <th>до 0,3 т (₽/т)</th>
                  <th>0,3–1 т (₽/т)</th>
                  <th>1–5 т (₽/т)</th>
                  <th>Вес 1 шт, кг</th>
                  <th>Цена 1 шт, ₽</th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="9" style="color:var(--muted)">Нет позиций по фильтрам</td></tr>`}
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    // ✅ НОВОЕ: читаем #search= из hash
    function readHashSearch(){
      const h = (location.hash || "");
      if(!h) return null;
      if(h.startsWith("#search=")){
        try{
          return decodeURIComponent(h.slice("#search=".length));
        }catch(e){
          return h.slice("#search=".length);
        }
      }
      return null;
    }

    async function main(){
      const res = await fetch('products.json', {cache:'no-store'});
      const products = await res.json();

      const cats = [...new Set(products.map(p => p.category))];

      const $q = document.querySelector('#q');
      const $cat = document.querySelector('#cat');
      const $pmin = document.querySelector('#pmin');
      const $pmax = document.querySelector('#pmax');
      const $out = document.querySelector('#out');
      const $count = document.querySelector('#count');
      const $nav = document.querySelector('#nav');

      // Fill categories
      $cat.innerHTML = `<option value="">Все категории</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join('');

      // Sidebar nav
      $nav.innerHTML = cats.map(c => `<a href="#${slugify(c)}">${c}</a>`).join("");

      function apply(){
        const q = ($q.value || "").trim();
        const cat = $cat.value;
        const min = parseInt(($pmin.value || "").replace(/\D/g,""), 10) || null;
        const max = parseInt(($pmax.value || "").replace(/\D/g,""), 10) || null;

        const filtered = products.filter(p =>
          (!cat || p.category === cat) &&
          rowMatches(p, q) &&
          withinPrice(p, min, max)
        );

        // group
        const map = new Map();
        for(const p of filtered){
          const key = p.category || "Без категории";
          if(!map.has(key)) map.set(key, []);
          map.get(key).push(p);
        }

        let html = "";
        for(const [k, list] of map.entries()){
          html += renderSection(k, list);
        }
        $out.innerHTML = html || `<div class="notice">По текущим фильтрам ничего не найдено.</div>`;
        $count.textContent = `${filtered.length} позиций`;
      }

      [$q, $cat, $pmin, $pmax].forEach(el => el.addEventListener('input', apply));

      // ✅ НОВОЕ: если пришли с #search=..., подставляем запрос и применяем
      const hashSearch = readHashSearch();
      if(hashSearch){
        $q.value = hashSearch;
      }

      apply();

      // ✅ СКРОЛЛ: если hash НЕ search — скроллим к категории как раньше
      const h = location.hash?.slice(1);
      if(h && !h.startsWith("search=")){
        setTimeout(() => {
          const el = document.getElementById(h);
          if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
        }, 250);
      }
    }

    main();
  </script>
</body>
</html>